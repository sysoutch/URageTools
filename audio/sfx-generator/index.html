<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URage Pulse - SFX Generator</title>
    <style>
        :root {
            --primary: #ff8a00;
            --secondary: #e52e71;
            --bg: #0f0f1a;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: radial-gradient(circle at center, #1a1a2e 0%, var(--bg) 100%);
            color: white; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container { 
            background: var(--glass); 
            padding: 40px; 
            border-radius: 24px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center; 
            max-width: 500px;
            width: 100%;
        }

        h1 {
            margin-top: 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2rem;
        }

        .section-label {
            display: block;
            margin: 20px 0 10px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        button { 
            padding: 12px; 
            border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: white; 
            cursor: pointer; 
            transition: all 0.2s;
        }

        button:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        button.active { background: var(--primary); border-color: var(--primary); }

        .controls { 
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .control-group { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        /* Lock Button Styles */
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .lock-btn {
            background: none;
            border: none;
            padding: 0;
            color: rgba(255,255,255,0.3);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .lock-btn.locked {
            color: var(--primary);
        }

        /* ADSR Visual Container */
        .adsr-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        input[type=range] { flex: 1; margin-left: 15px; accent-color: var(--primary); }

        .main-actions {
            display: flex;
            gap: 15px;
        }

        .btn-play { background: linear-gradient(135deg, #00c9ff, #007bff); flex: 2; font-weight: bold; border: none; }
        .btn-download { background: linear-gradient(135deg, var(--primary), var(--secondary)); flex: 1; font-weight: bold; border: none; }

        .visualizer-container {
            width: 100%;
            height: 100px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        canvas { width: 100%; height: 100%; }

        /* Random Button Style */
        .btn-random {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            margin-bottom: 10px;
            width: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>URage Pulse</h1>
    
    <span class="section-label">Presets</span>
    <div class="button-group">
        <button onclick="applyPreset('jump')">ðŸš€ Jump</button>
        <button onclick="applyPreset('explosion')">ðŸ’¥ Boom</button>
        <button onclick="applyPreset('blip')">âœ¨ Blip</button>
        <button onclick="applyPreset('laser')">ðŸ”« Laser</button>
    </div>

    <span class="section-label">Waveform</span>
    <div class="button-group" id="waveSelectors">
        <button onclick="setWave('square', this)" class="active">Square</button>
        <button onclick="setWave('sawtooth', this)">Saw</button>
        <button onclick="setWave('sine', this)">Sine</button>
        <button onclick="setWave('triangle', this)">Tri</button>
    </div>


    <div class="visualizer-container">
        <canvas id="canvas"></canvas>
    </div>

    <button class="btn-random" onclick="randomize()">ðŸŽ² Randomize Params</button>

    <div class="controls">
        <div class="control-group">
            <div class="control-header">
                <label>Freq</label>
            </div>
            <input type="range" id="freq" min="50" max="2000" value="440">
            <button class="lock-btn" id="lock-freq" onclick="toggleLock(this)">ðŸ”“</button>
        </div>

        <div class="control-group">
            <div class="control-header">
                <label>Length</label>
            </div>
            <input type="range" id="duration" min="0.05" max="2.0" step="0.05" value="0.3">
            <button class="lock-btn" id="lock-duration" onclick="toggleLock(this)">ðŸ”“</button>
        </div>

        <div class="control-group">
            <div class="control-header">
                <label>Slide</label>
            </div>
            <input type="range" id="slide" min="-1000" max="1000" step="10" value="-400">
            <button class="lock-btn" id="lock-slide" onclick="toggleLock(this)">ðŸ”“</button>
        </div>

        <span class="section-label">Envelope (ADSR)</span>
        <div class="adsr-grid">
            <div class="control-group">
                <label>Atk</label>
                <input type="range" id="attack" min="0" max="0.5" step="0.01" value="0.01">
            </div>
            <div class="control-group">
                <label>Dec</label>
                <input type="range" id="decay" min="0" max="0.5" step="0.01" value="0.1">
            </div>
        </div>
    </div>

    <div class="main-actions">
        <button class="btn-play" onclick="playSFX()">ðŸ”Š PLAY</button>
        <button class="btn-download" onclick="downloadSFX()">ðŸ’¾ WAV</button>
    </div>
</div>

<script>
    let waveType = 'square';
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const canvas = document.getElementById('canvas');
    const canvasCtx = canvas.getContext('2d');
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;

    function setWave(type, btn) {
        waveType = type;
        document.querySelectorAll('#waveSelectors button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function applyPreset(type) {
        const f = document.getElementById('freq');
        const d = document.getElementById('duration');
        const s = document.getElementById('slide');

        if (type === 'jump') { f.value = 150; d.value = 0.6; s.value = 600; waveType = 'square'; }
        else if (type === 'explosion') { f.value = 100; d.value = 1.0; s.value = -80; waveType = 'sawtooth'; }
        else if (type === 'blip') { f.value = 800; d.value = 0.1; s.value = -200; waveType = 'sine'; }
        else if (type === 'laser') { f.value = 1500; d.value = 0.3; s.value = -1400; waveType = 'sawtooth'; }
        
        // Visual feedback for wave buttons
        const btns = document.querySelectorAll('#waveSelectors button');
        btns.forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(waveType.substring(0,3))));
        playSFX();
    }

    function getParams() {
        return {
            startFreq: parseFloat(document.getElementById('freq').value),
            duration: parseFloat(document.getElementById('duration').value),
            slide: parseFloat(document.getElementById('slide').value)
        };
    }

    function toggleLock(btn) {
        btn.classList.toggle('locked');
        btn.innerText = btn.classList.contains('locked') ? 'ðŸ”’' : 'ðŸ”“';
    }

    function randomize() {
        // Only change if NOT locked
        if (!document.getElementById('lock-freq').classList.contains('locked')) {
            document.getElementById('freq').value = Math.floor(Math.random() * 1500 + 100);
        }

        if (!document.getElementById('lock-duration').classList.contains('locked')) {
            document.getElementById('duration').value = (Math.random() * 1.5 + 0.1).toFixed(2);
        }
        
        if (!document.getElementById('lock-slide').classList.contains('locked')) {
            document.getElementById('slide').value = Math.floor(Math.random() * 2000 - 1000);
        }

        const waves = ['square', 'sawtooth', 'sine', 'triangle'];
        const randomWave = waves[Math.floor(Math.random() * waves.length)];
        const buttons = document.querySelectorAll('#waveSelectors button');
        buttons.forEach(btn => {
            if(btn.innerText.toLowerCase().includes(randomWave.substring(0,3))) {
                setWave(randomWave, btn);
            }
        });

        playSFX();
    }

    function playSFX() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const p = {
            startFreq: parseFloat(document.getElementById('freq').value),
            duration: parseFloat(document.getElementById('duration').value),
            slide: parseFloat(document.getElementById('slide').value),
            attack: parseFloat(document.getElementById('attack').value),
            decay: parseFloat(document.getElementById('decay').value)
        };

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        // Frequency Slide
        osc.type = waveType;
        osc.frequency.setValueAtTime(p.startFreq, audioCtx.currentTime);
        const endFreq = Math.max(1, p.startFreq + p.slide);
        osc.frequency.exponentialRampToValueAtTime(endFreq, audioCtx.currentTime + p.duration);

        // ADSR Envelope Logic
        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(0, now);
        // Attack: Fade in to max volume
        gain.gain.linearRampToValueAtTime(0.3, now + p.attack);
        // Decay: Fade down to "sustain" level (we'll use 0.0001 for a clean tail)
        gain.gain.exponentialRampToValueAtTime(0.0001, now + p.attack + p.decay + p.duration);

        osc.connect(gain);
        gain.connect(analyser); // From previous visualizer step
        analyser.connect(audioCtx.destination);

        osc.start();
        osc.stop(now + p.duration + p.attack + p.decay);
    }

    async function downloadSFX() {
        const p = getParams();
        const sampleRate = 44100;
        const offlineCtx = new OfflineAudioContext(1, sampleRate * p.duration, sampleRate);
        
        const osc = offlineCtx.createOscillator();
        const gain = offlineCtx.createGain();
        
        osc.type = waveType;
        osc.frequency.setValueAtTime(p.startFreq, 0);
        const endFreq = Math.max(1, p.startFreq + p.slide);
        osc.frequency.exponentialRampToValueAtTime(endFreq, p.duration);
        
        gain.gain.setValueAtTime(0.2, 0);
        gain.gain.exponentialRampToValueAtTime(0.0001, p.duration);
        
        osc.connect(gain);
        gain.connect(offlineCtx.destination);
        osc.start();
        osc.stop(p.duration);
        
        const buffer = await offlineCtx.startRendering();
        const blob = bufferToWave(buffer, sampleRate * p.duration);
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `sfx-${Date.now()}.wav`;
        link.click();
    }

    function bufferToWave(abuffer, len) {
        let numOfChan = abuffer.numberOfChannels,
            length = len * numOfChan * 2 + 44,
            buffer = new ArrayBuffer(length),
            view = new DataView(buffer),
            channels = [], i, sample, offset = 0, pos = 0;

        const setUint16 = d => { view.setUint16(pos, d, true); pos += 2; };
        const setUint32 = d => { view.setUint32(pos, d, true); pos += 4; };

        setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
        setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
        setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
        setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);

        for(i = 0; i < numOfChan; i++) channels.push(abuffer.getChannelData(i));
        while(pos < length) {
            for(i = 0; i < numOfChan; i++) {
                sample = Math.max(-1, Math.min(1, channels[i][offset]));
                view.setInt16(pos, (sample < 0 ? sample * 0x8000 : sample * 0x7FFF), true);
                pos += 2;
            }
            offset++;
        }
        return new Blob([buffer], {type: "audio/wav"});
    }

    function draw() {
        requestAnimationFrame(draw);
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteTimeDomainData(dataArray);

        canvasCtx.fillStyle = 'rgba(15, 15, 26, 0.2)';
        canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = '#ff8a00';
        canvasCtx.beginPath();

        const sliceWidth = canvas.width * 1.0 / bufferLength;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * canvas.height / 2;
            if (i === 0) canvasCtx.moveTo(x, y);
            else canvasCtx.lineTo(x, y);
            x += sliceWidth;
        }
        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();
    }
    draw();
</script>
</body>
</html>
